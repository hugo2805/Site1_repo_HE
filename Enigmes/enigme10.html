<link rel="stylesheet" type="text/css" href="../css/default.css">


<body id="content">

	<div class="parchemin">
		<p>
			Positionnez les 5 jetons de façon à relier les 9 points.
		</p>
	</div>

	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>
	<div class="dot"></div>

    <canvas id="canvas"></canvas>

	<div id="b1" class="beacon" ontouchestart="SwitchObjectDragged(this.id, true)" ontouchend="SwitchObjectDragged(this.id, false)">1</div>
	<div id="b2" class="beacon" ontouchstart="SwitchObjectDragged(this.id, true)" ontouchend="SwitchObjectDragged(this.id, false)">2</div>
	<div id="b3" class="beacon" ontouchstart="SwitchObjectDragged(this.id, true)" ontouchend="SwitchObjectDragged(this.id, false)">3</div>
	<div id="b4" class="beacon" ontouchstart="SwitchObjectDragged(this.id, true)" ontouchend="SwitchObjectDragged(this.id, false)">4</div>
	<div id="b5" class="beacon" ontouchstart="SwitchObjectDragged(this.id, true)" ontouchend="SwitchObjectDragged(this.id, false)">5</div>
</body>


<style>
	.dot{
		position: absolute;

		width: 5vw;
		height: 5vw;

		border-radius: 50%;
		background-color: black;
		box-shadow: 0 0 10px black;
	}

	.beacon{
		position: absolute;

		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;

		color: white;

		width: 7vw;
		height: 7vw;

		border-radius: 50%;
		background: radial-gradient(circle, rgba(212,180,132,1) 0%, rgba(109,91,69,1) 100%);

		box-shadow: 0 0 10px black;
		cursor: pointer;
	}

	.wire{
		position: absolute;
		width: 10vw;
		height: 1vw;
		background-color: grey;
	}

	#canvas{
		position: absolute;
		width: 100vw;
		height: 100vh;
	}

	.parchemin{
		position: absolute;
		bottom: 10vh;
	}
</style>

<script>
	var canvas = document.getElementById("canvas");
	canvas.width = canvas.clientWidth;
	canvas.height = canvas.width * (canvas.clientHeight / canvas.clientWidth);
	var ctx = canvas.getContext("2d");
	var beaconWidth = canvas.clientWidth * .07;
	var dotWidth = canvas.clientWidth * .05;

	var dots = document.getElementsByClassName("dot");

	var b1 = document.getElementById("b1");
	var b2 = document.getElementById("b2");
	var b3 = document.getElementById("b3");
	var b4 = document.getElementById("b4");
	var b5 = document.getElementById("b5");

	b1.style.left = "200px";
	b1.style.top = "100px";

	b2.style.left = "100px";
	b2.style.top = "200px";

	b3.style.left = "200px";
	b3.style.top = "300px";

	b4.style.left = "230px";
	b4.style.top = "150px";

	b5.style.left = "0px";
	b5.style.top = "0px";

	for (var i = 0; i < 3; i++){
		for (var j = 0; j < 3; j++){
			dots[3*i+j].style.left = (2+i)*(canvas.clientWidth - dotWidth/2)/6;
			dots[3*i+j].style.top  = (2+j)*(canvas.clientWidth - dotWidth/2)/6;
		}
	}

	function SetWire(beaconA, beaconB){
		ctx.moveTo(parseInt(beaconA.style.left) + beaconWidth/2, parseInt(beaconA.style.top) + beaconWidth/2);
		ctx.lineTo(parseInt(beaconB.style.left) + beaconWidth/2, parseInt(beaconB.style.top) + beaconWidth/2);
	}

	function ClearCanvas(context, canvas){
		context.clearRect(0, 0, canvas.width, canvas.height);
		var w = canvas.width;
		canvas.width = 1;
		canvas.width = w;
	}

	function UpdateWires(){
		ClearCanvas(ctx, canvas);
		ctx.beginPath();
		ctx.lineWidth = 5;
		SetWire(b1, b2);
		SetWire(b2, b3);
		SetWire(b3, b4);
		SetWire(b4, b5);
		ctx.strokeStyle = '#886666';
		ctx.stroke();
	}

	UpdateWires();

	// --- DRAG n DROP ---

	var draggedObject = null;

	document.ontouchmove = FollowCursorPosition;

	function FollowCursorPosition(event){
		if (draggedObject){
			var e = event || window.event;
            // console.log(e.touches[0].clientX + ' ' + e.touches[0].clientY);
            draggedObject.style.left = e.touches[0].clientX - beaconWidth/2;
            draggedObject.style.top = e.touches[0].clientY - beaconWidth/2;
			UpdateWires();
			VerifyDots();
			Won();
		}
	}

	function SwitchObjectDragged(objId, selected) {
		if (draggedObject){
			if (draggedObject.id == objId)
				draggedObject = null;
			else
				draggedObject = document.getElementById(objId);
		}else{
			draggedObject = document.getElementById(objId);
		}
		if (!selected)
			draggedObject = null;
	}

	function VerifyDots(){
		for (var i = 0; i < 9; i++){
			var isConnected = false;

			isConnected += IsUnderWire(dots[i], b1, b2);
			isConnected += IsUnderWire(dots[i], b2, b3);
			isConnected += IsUnderWire(dots[i], b3, b4);
			isConnected += IsUnderWire(dots[i], b4, b5);

			if (isConnected)
				dots[i].style.backgroundColor = "white";
			else
				dots[i].style.backgroundColor = "black";
		}
	}

	function IsUnderWire(dot, beaconA, beaconB){
		var distA = Math.pow((Math.pow(parseInt(dot.style.left) - parseInt(beaconA.style.left), 2) + Math.pow(parseInt(dot.style.top) - parseInt(beaconA.style.top), 2)), .5);
		var distB = Math.pow((Math.pow(parseInt(dot.style.left) - parseInt(beaconB.style.left), 2) + Math.pow(parseInt(dot.style.top) - parseInt(beaconB.style.top), 2)), .5);
		var hypo = Math.pow((Math.pow(parseInt(beaconB.style.left) - parseInt(beaconA.style.left), 2) + Math.pow(parseInt(beaconB.style.top) - parseInt(beaconA.style.top), 2)), .5);

		return (((distA+distB)-hypo)/hypo < .005);
	}

	function Won(){
		var isWon = true;
		for (var i = 0; i < 9; i++)
			if (dots[i].style.backgroundColor == "black")
				isWon = false;
		if (isWon)
			alert("VICTORY !");
	}

</script>